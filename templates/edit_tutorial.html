<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script>{% extends "base.html" %}
{% block title %}Editar Vídeo Tutorial{% endblock %}
{% block content %}
<div class="max-w-8xl mx-auto">
    <h2 class="text-2xl font-bold mb-6">Editar Vídeo Tutorial</h2>
    <form method="POST" enctype="multipart/form-data" class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
        <div class="mb-4">
            <label for="title" class="block text-gray-700 font-semibold mb-2">Título:</label>
            <input type="text" name="title" id="title" value="{{ tutorial.title }}" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div class="mb-4">
            <label for="description" class="block text-gray-700 font-semibold mb-2">Descrição:</label>
            <textarea name="description" id="description" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>{{ tutorial.description }}</textarea>
        </div>
        <div class="mb-4">
            <label for="product" class="block text-gray-700 font-semibold mb-2">Produto:</label>
            <select name="product" id="product" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                <option value="Creo Parametric" {% if tutorial.product == 'Creo Parametric' %}selected{% endif %}>Creo Parametric</option>
                <option value="Creo View" {% if tutorial.product == 'Creo View' %}selected{% endif %}>Creo View</option>
                <option value="Windchill" {% if tutorial.product == 'Windchill' %}selected{% endif %}>Windchill</option>
                <option value="Toolkit" {% if tutorial.product == 'Toolkit' %}selected{% endif %}>Toolkit</option>
                <option value="Illustrate" {% if tutorial.product == 'Illustrate' %}selected{% endif %}>Illustrate</option>
                <option value="Mathcad" {% if tutorial.product == 'Mathcad' %}selected{% endif %}>Mathcad</option>
                <option value="Outros" {% if tutorial.product == 'Outros' %}selected{% endif %}>Outros</option>
            </select>
        </div>
        <div class="mb-4" id="subproduct-container" style="display: {% if tutorial.product == 'Creo Parametric' %}block{% else %}none{% endif %};">
            <label for="subproduct" class="block text-gray-700 font-semibold mb-2">Sub-Produto:</label>
            <select name="subproduct" id="subproduct" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="" {% if not tutorial.subproduct %}selected{% endif %}>Nenhum</option>
                <option value="Simulation" {% if tutorial.subproduct == 'Simulation' %}selected{% endif %}>Simulation</option>
                <option value="Creo Ansys" {% if tutorial.subproduct == 'Creo Ansys' %}selected{% endif %}>Creo Ansys</option>
                <option value="Render" {% if tutorial.subproduct == 'Render' %}selected{% endif %}>Render</option>
                <option value="Cabling" {% if tutorial.subproduct == 'Cabling' %}selected{% endif %}>Cabling</option>
                <option value="Piping" {% if tutorial.subproduct == 'Piping' %}selected{% endif %}>Piping</option>
                <option value="Manufacturing" {% if tutorial.subproduct == 'Manufacturing' %}selected{% endif %}>Manufacturing</option>
            </select>
        </div>
        <div class="mb-4">
            <label for="video" class="block text-gray-700 font-semibold mb-2">Vídeo (opcional):</label>
            <div class="dropzone" ondragover="dragOverHandler(event)" ondragleave="dragLeaveHandler(event)" ondrop="dropHandler(event)" onclick="triggerFileInput()">
                <p>Arraste e solte o vídeo aqui ou clique para selecionar</p>
            </div>
            <input type="file" name="video" id="video" accept="video/mp4,video/mov,video/avi,video/wmv,video/flv,video/webm" style="display: none;" onchange="updateFileDisplay(this.files)">
            <small id="fileNameDisplay" class="block mt-2 text-gray-600">Vídeo atual: {{ tutorial.video_path if tutorial.video_path else 'Nenhum vídeo' }}</small>
            <small id="errorMessage" class="block mt-2 text-red-600"></small>
            <p class="text-gray-500 text-sm mt-1">Formatos suportados: MP4, MOV, AVI, WMV, FLV, WEBM</p>
        </div>
        <input type="hidden" name="modified_by_username" value="{{ current_user.username }}">
        <div class="flex space-x-4">
            <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Salvar Alterações</button>
            <a href="{{ url_for('tutorials') }}" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg shadow hover:bg-gray-400 transition-colors">Cancelar</a>
        </div>
    </form>
    <script>
        document.getElementById('product').addEventListener('change', function() {
            var subproductContainer = document.getElementById('subproduct-container');
            if (this.value === 'Creo Parametric') {
                subproductContainer.style.display = 'block';
            } else {
                subproductContainer.style.display = 'none';
                document.getElementById('subproduct').value = '';
            }
        });

        const allowedExtensions = ['mp4', 'mov', 'avi', 'wmv', 'flv', 'webm'];

        function isFileSupported(file) {
            const extension = file.name.split('.').pop().toLowerCase();
            return allowedExtensions.includes(extension);
        }

        function dragOverHandler(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('dragover');
        }

        function dragLeaveHandler(ev) {
            ev.currentTarget.classList.remove('dragover');
        }

        function dropHandler(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('dragover');
            const fileInput = document.getElementById('video');
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            const errorMessage = document.getElementById('errorMessage');
            const dataTransfer = new DataTransfer();

            errorMessage.textContent = '';

            if (ev.dataTransfer.files.length > 0) {
                Array.from(ev.dataTransfer.files).forEach(file => {
                    if (isFileSupported(file)) {
                        dataTransfer.items.add(file);
                    } else {
                        errorMessage.textContent = `Erro: O arquivo "${file.name}" não é suportado.`;
                    }
                });
                fileInput.files = dataTransfer.files;
                updateFileDisplay(fileInput.files);
            }
        }

        function triggerFileInput() {
            document.getElementById('video').click();
        }

        function updateFileDisplay(files) {
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            const errorMessage = document.getElementById('errorMessage');
            if (files.length > 0) {
                Array.from(files).forEach(file => {
                    if (!isFileSupported(file)) {
                        errorMessage.textContent = `Erro: O arquivo "${file.name}" não é suportado.`;
                    }
                });
                fileNameDisplay.textContent = `Vídeo selecionado: ${Array.from(files).map(file => file.name).join(', ')}`;
            }
        }
    </script>
    <style>
        .dropzone {
            border: 2px dashed #ccc;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            background-color: #f9f9f9;
            transition: all 0.4s ease-in-out;
        }
        .dropzone.dragover {
            border-color: #1e90ff;
            background-color: #d1e7ff;
            box-shadow: 0 0 15px rgba(30, 144, 255, 0.7);
            transform: translateY(-5px);
            animation: enhancedPulse 1.2s infinite;
        }
        @keyframes enhancedPulse {
            0% {
                transform: translateY(-5px) scale(1);
                box-shadow: 0 0 15px rgba(30, 144, 255, 0.7);
            }
            50% {
                transform: translateY(-5px) scale(1.05);
                box-shadow: 0 0 20px rgba(30, 144, 255, 0.9);
                background-color: #b3d9ff;
            }
            100% {
                transform: translateY(-5px) scale(1);
                box-shadow: 0 0 15px rgba(30, 144, 255, 0.7);
            }
        }
    </style>
</div>
{% endblock %}