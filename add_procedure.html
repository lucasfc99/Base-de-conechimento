{% extends "base.html" %}
{% block title %}Adicionar Procedimento Técnico{% endblock %}
{% block content %}
<div class="max-w-7.5xl mx-auto min-h-screen">
    <h2 class="text-3xl font-bold mb-6 text-gray-800">Adicionar Procedimento Técnico</h2>
    <form id="uploadForm" method="POST" enctype="multipart/form-data" class="bg-white p-6 rounded-lg shadow-md border border-gray-300">
        <div class="mb-4">
            <label for="title" class="block text-gray-600 mb-2">Título:</label>
            <input type="text" name="title" id="title" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>
        <div class="mb-4">
            <label for="product" class="block text-gray-600 mb-2">Produto:</label>
            <select name="product" id="product" required class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="handleProductChange()">
                <option value="">Selecione um produto</option>
                <option value="Creo Parametric">Creo Parametric</option>
                <option value="Creo View">Creo View</option>
                <option value="Windchill">Windchill</option>
                <option value="Toolkit">Toolkit</option>
                <option value="Illustrate">Illustrate</option>
                <option value="Mathcad">Mathcad</option>
                <option value="Outros">Outros</option>
            </select>
        </div>
        <div class="mb-4" id="subproduct-container" style="display: none;">
            <label for="subproduct" class="block text-gray-600 mb-2">Sub-Produto:</label>
            <select name="subproduct" id="subproduct" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Nenhum</option>
                <option value="Simulation">Simulation</option>
                <option value="Creo Ansys">Creo Ansys</option>
                <option value="Render">Render</option>
                <option value="Cabling">Cabling</option>
                <option value="Piping">Piping</option>
            </select>
        </div>
        <div class="mb-4">
            <label for="file" class="block text-gray-600 mb-2">Arquivo (Máximo 2 GB)</label>
            <div id="drop-area" class="w-full p-6 border-2 border-dashed border-gray-300 rounded-lg text-center cursor-pointer hover:border-gray-400 transition-colors">
                <input type="file" name="file" id="file" required class="hidden">
                <p id="file-name" class="text-gray-500">Arraste e solte o arquivo aqui ou clique para selecionar (máximo 2 GB)</p>
            </div>
            <div id="progress-bar-container" class="mt-2 hidden">
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-sm text-gray-600 mt-1">0%</p>
            </div>
        </div>
        <div class="flex space-x-2">
            <button type="submit" id="submit-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition-colors">Adicionar</button>
            <a href="{{ url_for('procedures') }}" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg shadow hover:bg-gray-400 transition-colors">Cancelar</a>
        </div>
    </form>
    <!-- Botão para Importação em Lote -->
    <div class="mt-6">
        <a href="{{ url_for('add_procedure_batch') }}" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow hover:bg-green-700 transition-colors">Importação em Lote</a>
    </div>
</div>
<script>
    function handleProductChange() {
        var productSelect = document.getElementById('product');
        var subproductContainer = document.getElementById('subproduct-container');
        var subproductSelect = document.getElementById('subproduct');
        if (productSelect.value === 'Creo Parametric') {
            subproductContainer.style.display = 'block';
        } else {
            subproductContainer.style.display = 'none';
            subproductSelect.value = '';
        }
    }

    // Drag-and-drop
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file');
    const fileNameDisplay = document.getElementById('file-name');
    const titleInput = document.getElementById('title');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
        }, false);
    });

    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => {
            dropArea.classList.add('border-blue-500', 'bg-blue-50');
        }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, () => {
            dropArea.classList.remove('border-blue-500', 'bg-blue-50');
        }, false);
    });

    dropArea.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            if (file.size <= 2 * 1024 * 1024 * 1024) {
                fileInput.files = files;
                fileNameDisplay.textContent = file.name;
                const extractedTitle = file.name.split('.').slice(0, -1).join('.').replace(/[^a-zA-Z0-9\s]/g, ' ').trim().split(/\s+/).map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                titleInput.value = extractedTitle;
                // Detectar produto com base no título
                const keywords = ['Creo', 'creo', 'Windchill', 'windchill'];
                if (keywords.some(keyword => extractedTitle.toLowerCase().includes(keyword.toLowerCase()))) {
                    document.getElementById('product').value = 'Creo Parametric';
                    handleProductChange(); // Atualizar subproduto
                } else {
                    document.getElementById('product').value = 'Outros';
                    handleProductChange(); // Atualizar subproduto
                }
            } else {
                fileNameDisplay.textContent = 'Erro: O arquivo excede o limite de 2 GB.';
                fileNameDisplay.classList.add('text-red-500');
            }
        }
    }, false);

    dropArea.addEventListener('click', () => {
        fileInput.click();
    });

    fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            if (file.size <= 2 * 1024 * 1024 * 1024) {
                fileNameDisplay.textContent = file.name;
                fileNameDisplay.classList.remove('text-red-500');
                const extractedTitle = file.name.split('.').slice(0, -1).join('.').replace(/[^a-zA-Z0-9\s]/g, ' ').trim().split(/\s+/).map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                titleInput.value = extractedTitle;
                // Detectar produto com base no título
                const keywords = ['Creo', 'creo', 'Windchill', 'windchill'];
                if (keywords.some(keyword => extractedTitle.toLowerCase().includes(keyword.toLowerCase()))) {
                    document.getElementById('product').value = 'Creo Parametric';
                    handleProductChange(); // Atualizar subproduto
                } else {
                    document.getElementById('product').value = 'Outros';
                    handleProductChange(); // Atualizar subproduto
                }
            } else {
                fileNameDisplay.textContent = 'Erro: O arquivo excede o limite de 2 GB.';
                fileNameDisplay.classList.add('text-red-500');
                fileInput.value = '';
            }
        }
    });

    // Upload com barra de progresso
    const form = document.getElementById('uploadForm');
    const progressBarContainer = document.getElementById('progress-bar-container');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const submitBtn = document.getElementById('submit-btn');

    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const file = formData.get('file');

        if (!file || file.size === 0) {
            alert('Por favor, selecione um arquivo.');
            return;
        }

        progressBarContainer.classList.remove('hidden');
        submitBtn.disabled = true;

        const xhr = new XMLHttpRequest();
        xhr.open('POST', form.action, true);
        xhr.responseType = 'json';

        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                progressBar.style.width = percentComplete + '%';
                progressText.textContent = Math.round(percentComplete) + '%';
            }
        });

        xhr.addEventListener('load', () => {
            if (xhr.status === 200) {
                try {
                    const response = xhr.response;
                    if (response.status === 'success') {
                        progressBar.style.width = '100%';
                        progressText.textContent = '100% - Concluído!';
                        setTimeout(() => {
                            window.location.href = response.redirect;
                        }, 1000);
                    } else {
                        progressText.textContent = response.message || 'Erro desconhecido.';
                        submitBtn.disabled = false;
                        alert(response.message || 'Erro ao adicionar procedimento.');
                    }
                } catch (e) {
                    progressText.textContent = 'Erro ao processar resposta do servidor.';
                    submitBtn.disabled = false;
                    alert('Erro ao processar resposta do servidor: ' + e.message);
                }
            } else {
                progressText.textContent = 'Erro no upload. Status: ' + xhr.status;
                submitBtn.disabled = false;
                alert('Erro no upload. Status: ' + xhr.status + ' - ' + (xhr.response?.message || 'Detalhes não disponíveis'));
            }
        });

        xhr.addEventListener('error', () => {
            progressText.textContent = 'Erro na conexão.';
            submitBtn.disabled = false;
            alert('Erro na conexão ao fazer upload do arquivo.');
        });

        xhr.send(formData);
    });
</script>
{% endblock %}